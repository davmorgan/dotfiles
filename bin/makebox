#!/usr/bin/env zsh
# set: ft=sh
set -e
setopt extendedglob

if [ -d *.vmx.lck ]; then
  echo "First Turn Off the VM"
  exit 1
fi

# verify we're in a vmware vm directory
pwd | grep vmwarevm > /dev/null 2>&1

# just another check, make sure the files in this directory look like vmware
# virtual machine files
ls -d *.(vmxf|nvram|vmsd|vmx|vmdk) > /dev/null 2>&1

# remove all files that are not essential for a vagrant box
rm -f $(ls -d *~*.(vmxf|nvram|vmsd|vmx|vmdk))

# defragment and shrink the main vmware disk
vmware-vdiskmanager -d "Virtual Disk.vmdk"
vmware-vdiskmanager -k "Virtual Disk.vmdk"

# create the metadata.json for vmware fusion
cat <<EOF > metadata.json
{
  "provider":"vmware_fusion"
}
EOF

# box it up using the virtual machine name as the box name.
box_name=$(basename "${PWD}" .vmwarevm)
tar cvzf "${box_name}.box" ./*
